<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chat App</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />

    <style>
      body {
        background: linear-gradient(135deg, #e0eafc, #cfdef3);
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          Roboto, sans-serif;
      }

      .chat-box {
        max-width: 650px;
        margin: 40px auto;
        background: #ffffff;
        border-radius: 12px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
        padding: 20px;
      }

      #message_content {
        max-height: 500px;
        overflow-y: auto;
        padding: 15px;
        background-color: #eef1f5;
        border-radius: 10px;
        margin-bottom: 15px;
      }

      .message {
        padding: 10px 15px;
        border-radius: 18px;
        max-width: 75%;
        margin-bottom: 4px;
        word-wrap: break-word;
        font-size: 0.95rem;
      }

      .avatar {
  width: 36px;
  height: 36px;
  border-radius: 50%;
  object-fit: cover;
}


      .sent {
        background-color: #dcf8c6;
        margin-left: auto;
      }

      .received {
        background-color: #ffffff;
        margin-right: auto;
      }

      .timestamp {
        font-size: 0.75rem;
        color: #6c757d;
        margin-bottom: 10px;
      }
      .signout-btn {
  position: fixed;
  top: 20px;
  right: 20px;
  z-index: 1000;
}

    </style>
  </head>

  <body>
    <div class="chat-box">
      <div id="userDeets" class="mb-3"></div>
      <div id="message_content"></div>
      <div class="input-group mb-3">
        <input
          type="text"
          id="message"
          class="form-control"
          placeholder="Type a message..."
        />
        <button class="btn btn-success" id="send">Send</button>
      </div>
      <button class="btn btn-danger signout-btn" id="signOut">
  Sign Out
</button>
    </div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
      import {
        getAuth,
        onAuthStateChanged,
        signOut,
      } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";
      import {
        getDatabase,
        ref,
        set,
        onValue,
        push,
      } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-database.js";

      const firebaseConfig = {
        apiKey: "AIzaSyBIJSxo0jM-I0sYoVK7qP3ixAl9oRiIW38",
        authDomain: "chatapp-34822.firebaseapp.com",
        databaseURL: "https://chatapp-34822-default-rtdb.firebaseio.com",
        projectId: "chatapp-34822",
        storageBucket: "chatapp-34822.appspot.com",
        messagingSenderId: "361213120069",
        appId: "1:361213120069:web:6b48635825e58148f21d2c",
      };

      const app = initializeApp(firebaseConfig);
      const auth = getAuth();
      const database = getDatabase(app);
      let currentUser = null;

      onAuthStateChanged(auth, (user) => {
        if (user) {
          currentUser = user;

          document.getElementById("userDeets").innerHTML = `
            <div class="p-3 bg-light d-flex align-items-center rounded shadow-sm">
              <img src="${user.photoURL}" alt="User" width="40" class="rounded-circle me-2" />
              <h5 class="mb-0">Welcome, ${user.displayName}</h5>
            </div>
          `;

          listenForMessages();
        } else {
          window.location.href = "./index.html";
        }
      });

      document.getElementById("signOut").addEventListener("click", () => {
        signOut(auth)
          .then(() => {
            console.log("User signed out.");
          })
          .catch((error) => {
            console.error("Sign out error:", error);
          });
      });

      document.getElementById("send").addEventListener("click", () => {
        const messageInput = document.getElementById("message");
        const message = messageInput.value.trim();
        if (message === "" || !currentUser) return;

        const chatRef = ref(database, "chats/");
        const newMsgRef = push(chatRef);

        set(newMsgRef, {
          message: message,
          senderId: currentUser.uid,
          senderName: currentUser.displayName,
          picture: currentUser.photoURL,
          timestamp: Date.now(),
        });

        messageInput.value = "";
      });

      function formatTime(ms) {
        const date = new Date(ms);
        return date.toLocaleTimeString([], {
          hour: "2-digit",
          minute: "2-digit",
        });
      }

      const defaultAvatar =
  "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgdmlld0JveD0iMCAwIDEwMCAxMDAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHJlY3Qgd2lkdGg9IjEwMCIgaGVpZ2h0PSIxMDAiIGZpbGw9IiNlOWVjZWYiLz48Y2lyY2xlIGN4PSI1MCIgY3k9IjM4IiByPSIxOCIgc3Ryb2tlPSIjYmJiIiBmaWxsPSIjZGRkIi8+PHBhdGggZD0iTTIwIDg1YzAtMTcgMTUtMjUgMzAtMjVzMzAgOCAzMCAyNSIgc3Ryb2tlPSIjYmJiIiBmaWxsPSIjZGRkIi8+PC9zdmc+";
      
  function listenForMessages() {
        const chatRef = ref(database, "chats/");
        const messageContainer = document.getElementById("message_content");

        onValue(chatRef, (snapshot) => {
          const data = snapshot.val();
          messageContainer.innerHTML = "";

          if (data) {
            const messages = Object.values(data);
            messages.sort((a, b) => a.timestamp - b.timestamp);

            messages.forEach((msg) => {
              const isSender = msg.senderId === currentUser.uid;
              const alignmentClass = isSender ? "sent" : "received";
              const textAlign = isSender ? "text-end" : "text-start";
              const avatar =
  typeof msg.picture === "string" && msg.picture.trim() !== ""
    ? msg.picture
    : defaultAvatar;

const messageHTML = `
  <div class="d-flex ${isSender ? "justify-content-end" : "justify-content-start"} mb-2">
    ${!isSender ? `<img src="${avatar}" class="avatar me-2" />` : ""}
    <div class="d-flex flex-column ${textAlign}">
      <div class="message ${alignmentClass}">
        <strong>${msg.senderName}</strong><br />
        ${msg.message}
      </div>
      <div class="timestamp ${textAlign}">
        ${formatTime(msg.timestamp)}
      </div>
    </div>
    ${isSender ? `<img src="${avatar}" class="avatar ms-2" />` : ""}
  </div>
`;
              messageContainer.innerHTML += messageHTML;
            });

            messageContainer.scrollTop = messageContainer.scrollHeight;
          } else {
            messageContainer.innerHTML =
              "<p class='text-muted text-center'>No messages yet.</p>";
          }
        });
      }
    </script>
  </body>
</html>
