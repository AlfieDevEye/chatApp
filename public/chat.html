<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chat App</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />

    <style>
      body {
        background-color: #1e303c;
      }

      #message_content {
        max-height: 500px;
        overflow-y: auto;
        padding: 15px;
        background-color: #f0f2f5;
        border-radius: 10px;
        margin-bottom: 15px;
      }

      .message {
        padding: 10px 15px;
        border-radius: 20px;
        max-width: 70%;
        margin-bottom: 10px;
        word-wrap: break-word;
      }

      .sent {
        background-color: #dcf8c6;
        margin-left: auto;
      }

      .received {
        background-color: #ffffff;
        margin-right: auto;
      }

      .chat-box {
        max-width: 600px;
        margin: auto;
        margin-top: 30px;
      }
    </style>
  </head>

  <body>
    <div class="chat-box">
      <div id="userDeets" class="mb-3"></div>
      <div id="message_content"></div>
      <div class="input-group mb-3">
        <input
          type="text"
          id="message"
          class="form-control"
          placeholder="Type a message..."
        />
        <button class="btn btn-success" id="send">Send</button>
      </div>
      <button class="btn btn-danger w-100" id="signOut">Sign Out</button>
    </div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
      import {
        getAuth,
        onAuthStateChanged,
        signOut,
      } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";
      import {
        getDatabase,
        ref,
        set,
        onValue,
        push,
      } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-database.js";

      const firebaseConfig = {
        apiKey: "AIzaSyBIJSxo0jM-I0sYoVK7qP3ixAl9oRiIW38",
        authDomain: "chatapp-34822.firebaseapp.com",
        databaseURL: "https://chatapp-34822-default-rtdb.firebaseio.com",
        projectId: "chatapp-34822",
        storageBucket: "chatapp-34822.appspot.com",
        messagingSenderId: "361213120069",
        appId: "1:361213120069:web:6b48635825e58148f21d2c",
      };

      const app = initializeApp(firebaseConfig);
      const auth = getAuth();
      const database = getDatabase(app);
      let currentUser = null;

      onAuthStateChanged(auth, (user) => {
        if (user) {
          currentUser = user;

          document.getElementById("userDeets").innerHTML = `
            <div class="p-3 bg-light d-flex align-items-center rounded shadow-sm">
              <img src="${user.photoURL}" alt="User" width="40" class="rounded-circle me-2" />
              <h5 class="mb-0">Welcome, ${user.displayName}</h5>
            </div>
          `;

          listenForMessages();
        } else {
          window.location.href = "./index.html";
        }
      });

      document.getElementById("signOut").addEventListener("click", () => {
        signOut(auth)
          .then(() => {
            //console.log("User signed out.");
          })
          .catch((error) => {
            //console.error("Sign out error:", error);
          });
      });

      document.getElementById("send").addEventListener("click", () => {
        const messageInput = document.getElementById("message");
        const message = messageInput.value.trim();
        if (message === "" || !currentUser) return;

        const chatRef = ref(database, "chats/");
        const newMsgRef = push(chatRef);

        set(newMsgRef, {
          message: message,
          senderId: currentUser.uid,
          senderName: currentUser.displayName,
          picture: currentUser.photoURL,
          timestamp: Date.now(),
        });

        messageInput.value = "";
      });
      function listenForMessages() {
        const chatRef = ref(database, "chats/");
        const messageContainer = document.getElementById("message_content");

        onValue(chatRef, (snapshot) => {
          const data = snapshot.val();
          messageContainer.innerHTML = "";

          if (data) {
            const messages = Object.values(data);
            messages.sort((a, b) => a.timestamp - b.timestamp);

            messages.forEach((msg) => {
              const isSender = msg.senderId === currentUser.uid;
              const alignmentClass = isSender ? "sent" : "received";
              const textAlign = isSender ? "text-end" : "text-start";

              const messageHTML = `
                <div class="d-flex flex-column ${textAlign}">
                  <div class="message ${alignmentClass}">
                    <strong>${msg.senderName}</strong><br />
                    ${msg.message}
                  </div>
                </div>
              `;
              messageContainer.innerHTML += messageHTML;
            });
            messageContainer.scrollTop = messageContainer.scrollHeight;
          } else {
            messageContainer.innerHTML =
              "<p class='text-muted text-center'>No messages yet.</p>";
          }
        });
      }
    </script>
  </body>
</html>



